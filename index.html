<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura OCR - H√≠brido PR + Google Vision</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #fff; text-align: center; }
    video, canvas { width: 100%; max-width: 480px; border: 2px solid #ccc; border-radius: 10px; }
    #guia {
      position: absolute; top: 50%; left: 50%; width: 250px; height: 80px;
      transform: translate(-50%, -50%); border: 2px dashed red; box-sizing: border-box; pointer-events: none;
    }
    #contenedorCamara { position: relative; display: inline-block; }
    #estadoOCR, #estadoSend { margin: 1rem 0; font-weight: bold; }
    button {
      padding: 10px 20px; font-size: 1rem; margin-top: 1rem;
      border-radius: 8px; border: none; background-color: #00c853; color: white; cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input[type="text"] {
      width: 100%; max-width: 320px; padding: .6rem .8rem;
      border-radius: 8px; border: 1px solid #444; background: #000; color: #fff;
    }
    .api-status {
      display: flex; justify-content: center; gap: 1rem; margin: 1rem 0; font-size: 0.9em;
      flex-wrap: wrap;
    }
    .api-counter { 
      padding: 0.5rem 1rem; border-radius: 20px; background: #333; 
    }
    .api-counter.pr { border: 2px solid #ff9800; }
    .api-counter.google { border: 2px solid #4285f4; }
    .method-selector {
      display: flex; gap: 0.5rem; margin: 1rem 0; justify-content: center;
      flex-wrap: wrap;
    }
    .method-btn {
      padding: 0.5rem 1rem; border-radius: 20px; border: 2px solid #444; 
      background: #222; color: #fff; cursor: pointer; font-size: 0.9em;
    }
    .method-btn.active { border-color: #00c853; background: #00c853; }
    .config-section {
      margin: 1rem 0; padding: 1rem; background: #222; border-radius: 10px;
    }
    .config-input {
      width: 100%; max-width: 400px; padding: 0.5rem; margin: 0.5rem 0;
      border-radius: 5px; border: 1px solid #444; background: #333; color: #fff;
    }
    .config-toggle { cursor: pointer; color: #4caf50; }
  </style>
</head>
<body>

  <h2>OCR H√≠brido - PR + Google Vision</h2>

  <div class="api-status">
    <div class="api-counter pr">
      <strong>Plate Recognizer:</strong> <span id="prCount">50</span> restantes
    </div>
    <div class="api-counter google">
      <strong>Google Vision:</strong> <span id="googleCount">1000</span> restantes/mes
    </div>
  </div>

  <div class="method-selector">
    <button id="methodAuto" class="method-btn active">ü§ñ Auto</button>
    <button id="methodPR" class="method-btn">üöÄ Plate Recognizer</button>
    <button id="methodGoogle" class="method-btn">üîç Google Vision</button>
  </div>

  <!-- Configuraci√≥n Google API -->
  <div class="config-section">
    <div class="config-toggle" onclick="toggleConfig()">‚öôÔ∏è Configurar Google Vision API</div>
    <div id="configSection" style="display:none; margin-top: 1rem;">
      <input type="text" id="googleApiKey" class="config-input" 
             placeholder="Tu Google Vision API Key..." 
             value="">
      <br>
      <small style="color: #ccc;">
        üìã <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #4285f4;">
          Obtener API Key gratuita (1000 usos/mes)
        </a>
      </small>
    </div>
  </div>

  <div id="contenedorCamara">
    <video id="video" autoplay muted playsinline></video>
    <div id="guia"></div>
  </div>

  <button id="btnCapturar" disabled>üì∏ Capturar</button>

  <p id="estadoOCR">Cargando c√°mara...</p>
  <input type="text" id="resultadoPlaca" placeholder="Placa detectada..." />

  <div>
    <button id="btnConfirmar">‚úÖ Confirmar y enviar</button>
  </div>
  <p id="estadoSend">Esperando confirmaci√≥n...</p>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const estadoOCR = document.getElementById('estadoOCR');
    const estadoSend = document.getElementById('estadoSend');
    const inputPlaca = document.getElementById('resultadoPlaca');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnConfirmar = document.getElementById('btnConfirmar');
    const prCount = document.getElementById('prCount');
    const googleCount = document.getElementById('googleCount');
    const googleApiKey = document.getElementById('googleApiKey');
    const ctx = canvas.getContext('2d');

    // APIs Configuration
    const API_TOKEN = '3f8ef072e79205794e226ac4c63907d1b081c500';

    // Estado del sistema
    let imagenOCRCapturada = "";
    let prUsageCount = parseInt(localStorage.getItem('prUsageCount') || '0');
    let googleUsageCount = parseInt(localStorage.getItem('googleUsageCount') || '0');
    let selectedMethod = 'auto';

    // UI Elements
    const methodBtns = {
      auto: document.getElementById('methodAuto'),
      pr: document.getElementById('methodPR'),
      google: document.getElementById('methodGoogle')
    };

    // Configuraci√≥n
    function toggleConfig() {
      const section = document.getElementById('configSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    // Cargar API key guardada
    googleApiKey.value = localStorage.getItem('googleVisionApiKey') || '';
    
    // Guardar API key cuando cambie
    googleApiKey.addEventListener('input', () => {
      localStorage.setItem('googleVisionApiKey', googleApiKey.value.trim());
    });

    // Actualizar contadores
    function updateCounts() {
      const prRemaining = Math.max(0, 50 - prUsageCount);
      const googleRemaining = Math.max(0, 1000 - googleUsageCount);
      
      prCount.textContent = prRemaining;
      googleCount.textContent = googleRemaining;
      
      if (prRemaining <= 5) {
        prCount.parentElement.style.borderColor = '#f44336';
      }
      if (googleRemaining <= 100) {
        googleCount.parentElement.style.borderColor = '#f44336';
      }
    }

    // Selector de m√©todo
    Object.entries(methodBtns).forEach(([method, btn]) => {
      btn.addEventListener('click', () => {
        Object.values(methodBtns).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedMethod = method;
        
        let statusText = '';
        switch(method) {
          case 'auto': statusText = 'Modo autom√°tico: PR primero, Google Vision de respaldo'; break;
          case 'pr': statusText = 'Forzando Plate Recognizer'; break;
          case 'google': statusText = 'Forzando Google Vision API'; break;
        }
        estadoOCR.textContent = statusText;
      });
    });

    // ==== C√°mara ====
    async function iniciarCamara() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' }, 
          audio: false 
        });
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          if (video.videoWidth && video.videoHeight) {
            btnCapturar.disabled = false;
            estadoOCR.textContent = 'C√°mara activa. Modo autom√°tico: PR + Google Vision.';
          }
        });
      } catch (err) {
        console.error('No se pudo acceder a la c√°mara:', err);
        estadoOCR.textContent = 'Error al acceder a la c√°mara ‚ùå';
      }
    }

    // Utilidades
    const normalizar = s => String(s || '').toUpperCase().replace(/[^A-Z0-9]/g, '');

    function snapshotDeVideo(videoEl) {
      const c = document.createElement('canvas');
      const w = videoEl.videoWidth || videoEl.clientWidth || 640;
      const h = videoEl.videoHeight || videoEl.clientHeight || 480;
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(videoEl, 0, 0, w, h);
      return c.toDataURL('image/jpeg', 0.8);
    }

    function imagenActualParaPendiente(videoEl, canvasEl) {
      try { if (videoEl && videoEl.readyState >= 2) return snapshotDeVideo(videoEl); } catch {}
      try {
        if (canvasEl && canvasEl.width && canvasEl.height) {
          return canvasEl.toDataURL('image/jpeg', 0.8);
        }
      } catch {}
      return '';
    }

    // OCR con Plate Recognizer
    async function reconocerConPlateRecognizer(blob) {
      const formData = new FormData();
      formData.append('upload', blob, 'captura.jpg');
      formData.append('regions', 'mx');
      formData.append('detection_detail', 'true');
      formData.append('camera_id', 'camara-viva');
      formData.append('config', JSON.stringify({
        blur: true, vehicle_detection: true, multiple_plates: false, 
        country: 'mx', detect_region: true
      }));

      const res = await fetch('https://api.platerecognizer.com/v1/plate-reader/', {
        method: 'POST', 
        headers: { Authorization: `Token ${API_TOKEN}` }, 
        body: formData
      });

      const data = await res.json();
      console.log('Respuesta PlateRecognizer:', data);

      // Actualizar contador de uso
      prUsageCount++;
      localStorage.setItem('prUsageCount', prUsageCount.toString());
      updateCounts();

      const resultado = data.results?.[0];
      if (resultado) {
        const placa = normalizar(resultado.plate);
        const score = Number(resultado.score || 0);
        return { placa, score, method: 'Plate Recognizer' };
      }

      return { placa: '', score: 0, method: 'Plate Recognizer' };
    }

    // OCR con Google Vision
    async function reconocerConGoogleVision(canvas) {
      const apiKey = googleApiKey.value.trim();
      if (!apiKey) {
        throw new Error('Google Vision API Key no configurada. Ve a ‚öôÔ∏è Configurar.');
      }

      const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
      
      const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          requests: [{
            image: { content: base64 },
            features: [{ type: 'TEXT_DETECTION', maxResults: 10 }]
          }]
        })
      });

      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data?.error?.message || 'Error en Google Vision API');
      }

      // Actualizar contador de uso
      googleUsageCount++;
      localStorage.setItem('googleUsageCount', googleUsageCount.toString());
      updateCounts();

      if (data.responses?.[0]?.textAnnotations) {
        const fullText = data.responses[0].textAnnotations[0].description;
        console.log('Texto detectado:', fullText);
        
        // Buscar patrones de placa mexicana (6-8 caracteres alfanum√©ricos)
        const placaPatterns = [
          /[A-Z]{3}[0-9]{4}/g,  // ABC1234
          /[A-Z]{3}[0-9]{3}/g,   // ABC123
          /[0-9]{3}[A-Z]{3}/g,   // 123ABC
          /[A-Z0-9]{6,8}/g       // General
        ];
        
        for (let pattern of placaPatterns) {
          const matches = fullText.match(pattern) || [];
          if (matches.length > 0) {
            const placa = normalizar(matches[0]);
            if (placa.length >= 6 && placa.length <= 8) {
              return { placa, score: 0.85, method: 'Google Vision' };
            }
          }
        }
      }

      return { placa: '', score: 0, method: 'Google Vision' };
    }

    // L√≥gica de decisi√≥n autom√°tica
    function shouldUsePlateRecognizer() {
      const prRemaining = Math.max(0, 50 - prUsageCount);
      
      switch(selectedMethod) {
        case 'pr': return prRemaining > 0;
        case 'google': return false;
        case 'auto': return prRemaining > 5; // Reservar los √∫ltimos 5 para emergencias
        default: return false;
      }
    }

    function shouldUseGoogleVision() {
      const googleRemaining = Math.max(0, 1000 - googleUsageCount);
      const hasApiKey = googleApiKey.value.trim().length > 0;
      
      switch(selectedMethod) {
        case 'pr': return false;
        case 'google': return hasApiKey && googleRemaining > 0;
        case 'auto': return hasApiKey && googleRemaining > 0;
        default: return false;
      }
    }

    // ==== Capturar y reconocer ====
    btnCapturar.addEventListener('click', async () => {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      imagenOCRCapturada = canvas.toDataURL('image/jpeg', 0.8);

      try {
        let resultado;

        if (shouldUsePlateRecognizer()) {
          estadoOCR.textContent = 'Procesando con Plate Recognizer...';
          canvas.toBlob(async (blob) => {
            try {
              resultado = await reconocerConPlateRecognizer(blob);
              procesarResultado(resultado);
            } catch (err) {
              console.error('PR fall√≥, probando Google Vision:', err);
              if (shouldUseGoogleVision()) {
                estadoOCR.textContent = 'PR fall√≥, usando Google Vision...';
                resultado = await reconocerConGoogleVision(canvas);
                procesarResultado(resultado);
              } else {
                estadoOCR.textContent = 'Error: Configura Google Vision como respaldo ‚ùå';
              }
            }
          }, 'image/jpeg', 0.9);
        } else if (shouldUseGoogleVision()) {
          estadoOCR.textContent = 'Procesando con Google Vision...';
          resultado = await reconocerConGoogleVision(canvas);
          procesarResultado(resultado);
        } else {
          estadoOCR.textContent = 'Sin m√©todos disponibles. Configura Google Vision API ‚ùå';
        }

      } catch (err) {
        console.error('Error en OCR:', err);
        estadoOCR.textContent = 'Error: ' + err.message;
      }
    });

    function procesarResultado(resultado) {
      if (resultado.placa) {
        inputPlaca.value = resultado.placa;
        
        const methodLabel = resultado.method === 'Plate Recognizer' ? 'üöÄ' : 'üîç';
        
        if (resultado.score < 0.8) {
          estadoOCR.textContent = `${methodLabel} Duda en lectura ‚ö†Ô∏è (${resultado.placa}). Corrige y CONFIRMA.`;
        } else {
          estadoOCR.textContent = `${methodLabel} Placa detectada ‚úÖ (${resultado.placa}). Revisa y CONFIRMA.`;
        }
      } else {
        estadoOCR.textContent = `${resultado.method} - No se detect√≥ placa ‚ùå`;
        inputPlaca.value = '';
      }
    }

    // ==== Confirmar y enviar ====
    let enviando = false;
    let _ultima = { placa:'', t:0 };

    async function existePendiente(placa) {
      try {
        const r = await fetch('/api/pendientes', { cache: 'no-store' });
        const data = await r.json();
        if (!r.ok) return false;
        const lista = Array.isArray(data.data) ? data.data : [];
        return lista.some(x => String(x.placa || '').toUpperCase() === placa);
      } catch { return false; }
    }

    btnConfirmar.addEventListener('click', async () => {
      const placa = normalizar(inputPlaca.value);
      if (!placa || placa.length < 5) {
        estadoSend.textContent = 'Placa inv√°lida. Corrige antes de enviar.'; 
        return;
      }

      const ahora = Date.now();
      if (_ultima.placa === placa && (ahora - _ultima.t) < 5000) {
        estadoSend.textContent = `Ya enviaste ${placa} hace poco.`; 
        return;
      }

      if (await existePendiente(placa)) {
        estadoSend.textContent = `Omitido: ${placa} ya est√° en pendientes.`; 
        inputPlaca.value = ''; 
        return;
      }

      if (enviando) return;
      enviando = true; 
      btnConfirmar.disabled = true;

      try {
        estadoSend.textContent = 'Enviando...';
        const imagen = imagenOCRCapturada || imagenActualParaPendiente(video, canvas);

        const r = await fetch('/api/pendientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa, imagen })
        });
        
        const data = await r.json();
        if (!r.ok) throw new Error(data?.msg || 'Error al enviar');

        try { localStorage.setItem('placaDetectadaOCR', placa); } catch {}
        _ultima = { placa, t: ahora };
        inputPlaca.value = '';
        estadoSend.textContent = `Enviado ‚úÖ (${placa}). Permanece en OCR.`;
        
      } catch (e) {
        console.error(e);
        estadoSend.textContent = 'No se pudo enviar la placa: ' + e.message;
      } finally {
        enviando = false; 
        btnConfirmar.disabled = false;
      }
    });

    // UX
    inputPlaca.addEventListener('input', e => {
      e.target.value = normalizar(e.target.value);
    });

    // Inicializar
    updateCounts();
    iniciarCamara();
  </script>
</body>
</html>