<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Prototipo OCR Placas</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    img, canvas { max-width: 100%; margin-top: 1rem; }
    input { width: 100%; padding: 8px; font-size: 1rem; margin-top: 1rem; }
    #estadoOCR { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Captura de Placa</h2>

  <input type="file" accept="image/*" capture="environment" id="fotoPlaca" />
  <img id="preview" alt="Previsualización" />
  <canvas id="canvas" style="display:none;"></canvas>

  <p id="estadoOCR">Esperando imagen...</p>
  <input type="text" id="resultadoPlaca" placeholder="Placa detectada..." />

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <script>
    const inputFoto = document.getElementById('fotoPlaca');
    const imgPreview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const inputPlaca = document.getElementById('resultadoPlaca');
    const estadoOCR = document.getElementById('estadoOCR');

    inputFoto.addEventListener('change', (e) => {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const url = URL.createObjectURL(archivo);
      imgPreview.src = url;

      imgPreview.onload = () => {
        estadoOCR.textContent = 'Procesando OCR...';

        // Ajustar canvas
        canvas.width = imgPreview.naturalWidth;
        canvas.height = imgPreview.naturalHeight;
        ctx.drawImage(imgPreview, 0, 0);

        // Binarizar imagen (mejora reconocimiento)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
          const value = avg > 128 ? 255 : 0;
          data[i] = data[i + 1] = data[i + 2] = value;
        }
        ctx.putImageData(imageData, 0, 0);

        // (Opcional) recorte del área donde suele estar la placa
        const cropHeight = canvas.height * 0.3;
        const startY = canvas.height * 0.4;
        const cropped = ctx.getImageData(0, startY, canvas.width, cropHeight);
        canvas.height = cropHeight;
        ctx.putImageData(cropped, 0, 0);

        // Ejecutar OCR
        Tesseract.recognize(canvas, 'eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          const placaDetectada = text.toUpperCase().match(/[A-Z]{3}[-\s]?\d{3}[-\s]?[A-Z0-9]/);
          inputPlaca.value = placaDetectada ? placaDetectada[0].replace(/[-\s]/g, '') : '';
          estadoOCR.textContent = placaDetectada ? 'Placa detectada ✅' : 'No se detectó placa ❌';
        }).catch(() => {
          estadoOCR.textContent = 'Error al procesar imagen ❌';
        });
      };
    });
  </script>
</body>
</html>
