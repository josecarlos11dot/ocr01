<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura OCR desde c√°mara en vivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #fff; text-align: center; }
    video, canvas { width: 100%; max-width: 480px; border: 2px solid #ccc; border-radius: 10px; }
    #guia {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 250px;
      height: 80px;
      transform: translate(-50%, -50%);
      border: 2px dashed red;
      box-sizing: border-box;
      pointer-events: none;
    }
    #contenedorCamara {
      position: relative;
      display: inline-block;
    }
    #estadoOCR { margin: 1rem 0; font-weight: bold; }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      border: none;
      background-color: #00c853;
      color: white;
    }
  </style>
</head>
<body>

  <h2>Captura de Placa (C√°mara en Vivo)</h2>

  <div id="contenedorCamara">
    <video id="video" autoplay muted playsinline></video>
    <div id="guia"></div>
  </div>

  <button id="btnCapturar">üì∏ Capturar</button>

  <p id="estadoOCR">Esperando captura...</p>
  <input type="text" id="resultadoPlaca" placeholder="Placa detectada..." />

 <!-- Campos normales -->
<input type="text" id="inputMarca" placeholder="Marca" />
<input type="text" id="inputModelo" placeholder="Modelo" />
<input type="text" id="inputColor" placeholder="Color" />

<!-- Ventana emergente si la placa no est√° en base -->
<div id="ventanaRegistro" style="display:none; background:#222; padding:1rem; margin-top:2rem; border-radius:10px; color:#fff;">
  <h3>Registrar nuevo veh√≠culo</h3>

  <label>Placa detectada:</label>
  <input id="nuevaPlaca" readonly />

  <label>Marca:</label>
  <input id="nuevaMarca" placeholder="Marca" />

  <label>Modelo:</label>
  <input id="nuevaModelo" placeholder="Modelo" />

  <label>Color:</label>
  <input id="nuevaColor" placeholder="Color" />

  <br><br>
  <button onclick="document.getElementById('ventanaRegistro').style.display='none'">Cancelar</button>
</div>

  <canvas id="canvas" style="display:none;"></canvas>
  <script>
    const baseDePlacas = [
      { placa: "GMA129F", marca: "NISSAN", modelo: "SENTRA", color: "ROJO" },
      { placa: "gxh278f", marca: "mazda", modelo: "3", color: "Verde" },
      { placa: "bdc285a", marca: "bmw", modelo: "325", color: "Gris" }
    ];
  
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const estadoOCR = document.getElementById('estadoOCR');
    const inputPlaca = document.getElementById('resultadoPlaca');
    const btnCapturar = document.getElementById('btnCapturar');
    const ctx = canvas.getContext('2d');
  
    const API_TOKEN = '3f8ef072e79205794e226ac4c63907d1b081c500';
  
    async function iniciarCamara() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        video.srcObject = stream;
      } catch (err) {
        console.error('No se pudo acceder a la c√°mara:', err);
        estadoOCR.textContent = 'Error al acceder a la c√°mara ‚ùå';
      }
    }
  
    iniciarCamara();
  
    btnCapturar.addEventListener('click', async () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
      estadoOCR.textContent = 'Procesando imagen...';
  
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('upload', blob, 'captura.jpg');
        formData.append('regions', 'mx');
        formData.append('detection_detail', 'true');
        formData.append('camera_id', 'camara-viva');
        formData.append('config', JSON.stringify({
          blur: true,
          vehicle_detection: true,
          multiple_plates: false,
          country: 'mx',
          detect_region: true
        }));
  
        try {
          const res = await fetch('https://api.platerecognizer.com/v1/plate-reader/', {
            method: 'POST',
            headers: { Authorization: `Token ${API_TOKEN}` },
            body: formData
          });
  
          const data = await res.json();
          console.log('Respuesta completa:', data);
  
          const resultado = data.results?.[0];
  
          if (resultado) {
            const placa = resultado.plate.toUpperCase();
            inputPlaca.value = placa;
  
            const score = resultado.score;
            estadoOCR.textContent = score < 0.85
              ? `Duda en lectura ‚ö†Ô∏è (${placa})`
              : 'Placa detectada ‚úÖ';
  
            // Asociaci√≥n autom√°tica
            const placaNormalizada = placa.toLowerCase().trim();
            const encontrado = baseDePlacas.find(auto => auto.placa === placaNormalizada);
  
            if (encontrado) {
              document.getElementById('inputMarca').value = encontrado.marca;
              document.getElementById('inputModelo').value = encontrado.modelo;
              document.getElementById('inputColor').value = encontrado.color;
              estadoOCR.textContent += ' - Datos cargados ‚úÖ';
            } else {
              estadoOCR.textContent += ' - No encontrada, abre registro ‚úçÔ∏è';
  
              const ventana = document.getElementById('ventanaRegistro');
              const campoNuevaPlaca = document.getElementById('nuevaPlaca');
  
              if (ventana && campoNuevaPlaca) {
                campoNuevaPlaca.value = placa;
                ventana.style.display = 'block';
              }
            }
  
          } else {
            estadoOCR.textContent = 'No se detect√≥ placa ‚ùå';
            inputPlaca.value = '';
          }
  
        } catch (err) {
          console.error('Error al enviar a Plate Recognizer:', err);
          estadoOCR.textContent = 'Error al procesar imagen ‚ùå';
        }
  
      }, 'image/jpeg', 0.9);
    });
  </script>
  
  
  
</body>
</html>
